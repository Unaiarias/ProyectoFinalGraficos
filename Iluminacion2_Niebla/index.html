<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Phong + Niebla (WebGL2)</title>

    <style>
        body {
            background: #222;
            color: white;
            font-family: sans-serif;
        }

        canvas {
            border: 1px solid white;
            width: 600px;
            height: 600px;
        }
    </style>


    <!-- Shaders como text/plain para evitar bloqueos -->
    <script id="vs" type="text/plain">
        #version 300 es
        precision mediump float;

        uniform mat4 modelViewMatrix;
        uniform mat4 projectionMatrix;
        uniform mat3 normalMatrix;

        in vec3 VertexPosition;
        in vec3 VertexNormal;

        out vec3 ecPositionOut;
        out vec3 ecNormalOut;

        void main() {
            vec4 ecPosition = modelViewMatrix * vec4(VertexPosition, 1.0);
            ecPositionOut = vec3(ecPosition);
            ecNormalOut = normalize(normalMatrix * VertexNormal);
            gl_Position = projectionMatrix * ecPosition;
        }
    </script>

    <!-- ================= FRAGMENT SHADER ================= -->

    <script id="fs" type="text/plain">
        #version 300 es
        precision mediump float;

        in vec3 ecPositionOut;
        in vec3 ecNormalOut;
        out vec4 fragmentColor;

        struct LightData {
            vec3 Position;
            vec3 La;
            vec3 Ld;
            vec3 Ls;
        };
        uniform LightData Light;

        struct MaterialData {
            vec3 Ka;
            vec3 Kd;
            vec3 Ks;
            float alpha;
        };
        uniform MaterialData Material;

        uniform float fogMin;
        uniform float fogMax;
        uniform vec3 fogColor;
        uniform int fogEnabled;
        uniform int fogMode;
        uniform float uTime;


        vec3 phong(vec3 N, vec3 L, vec3 V) {
            vec3 ambient = Material.Ka * Light.La;
            float NdotL = max(dot(N, L), 0.0);

            vec3 diffuse = NdotL * (Light.Ld * Material.Kd);
            vec3 specular = vec3(0.0);

            if (NdotL > 0.0) {
                vec3 H = normalize(L + V);
                float NdotH = max(dot(N, H), 0.0);
                specular = pow(NdotH, Material.alpha) * (Light.Ls * Material.Ks);
            }
            return ambient + diffuse + specular;
        }

        void main() {
            vec3 N = normalize(ecNormalOut);
            vec3 V = normalize(-ecPositionOut);
            vec3 L = normalize(Light.Position - ecPositionOut);

            vec3 litColor = phong(N, L, V);

            if (fogEnabled == 0) {
                fragmentColor = vec4(litColor, 1.0);
                return;
            }

        float dist = abs(ecPositionOut.z);

        // “viento” usando la posición del fragmento (en espacio de cámara)
        float drift = ecPositionOut.x * 0.6 + ecPositionOut.y * 0.2 + uTime * 1.2;
        float wave  = 0.5 + 0.5 * sin(drift);

        // aumentamos o reducimos la “distancia efectiva” => parece que la niebla avanza
        dist += wave * 1.2; // amplitud (ajústala a tu gusto)

            float fogFactor;

            if (fogMode == 0) {
                fogFactor = (fogMax - dist) / (fogMax - fogMin);
            } else {
                float dnorm = clamp((dist - fogMin) / (fogMax - fogMin), 0.0, 1.0);
                fogFactor = exp(-pow(dnorm * 3.0, 2.0));
            }

            fogFactor = clamp(fogFactor, 0.0, 1.0);
            vec3 finalColor = mix(fogColor, litColor, fogFactor);
            fragmentColor = vec4(finalColor, 1.0);
        }
    </script>

</head>

<body>
    <h2>Phong + Niebla (WebGL2)</h2>
    <canvas id="glCanvas" width="600" height="600"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.4.0/gl-matrix.js"></script>
    <script src="app.js"></script>
</body>
</html>
